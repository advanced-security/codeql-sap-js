name: QL Unit Tests (Windows)

# This workflow runs CodeQL unit tests for the 'javascript' language on Windows.
# The 'qlt' CLI is not supported on Windows, so this workflow uses 'codeql test run'
# directly, following the pattern from the Actions language unit tests workflow.
#
# Tests are run in parallel using a matrix strategy for improved performance.

on:
  pull_request:
    branches:
      - 'main'
    paths:
      - '.github/workflows/ql-unit-tests-windows.yml'
      - 'qlt.conf.json'
      - 'extractors/cds/**'
      - 'extractors/javascript/tools/**'
      - 'javascript/**'
  push:
    branches:
      - 'main'
    paths:
      - '.github/workflows/ql-unit-tests-windows.yml'
      - 'qlt.conf.json'
      - 'extractors/cds/**'
      - 'extractors/javascript/tools/**'
      - 'javascript/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  run-windows-tests:
    name: ${{ matrix.test_suite }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        test_suite:
          - cap-models
          - cap-queries
          - ui5-lib
          - ui5-models
          - ui5-queries
          - ui5-webcomponents-queries
          - xsjs-models
          - xsjs-queries
          - heuristic-models
        include:
          - test_suite: cap-models
            test_path: javascript/frameworks/cap/test/models
          - test_suite: cap-queries
            test_path: javascript/frameworks/cap/test/queries
          - test_suite: ui5-lib
            test_path: javascript/frameworks/ui5/test/lib
          - test_suite: ui5-models
            test_path: javascript/frameworks/ui5/test/models
          - test_suite: ui5-queries
            test_path: javascript/frameworks/ui5/test/queries
          - test_suite: ui5-webcomponents-queries
            test_path: javascript/frameworks/ui5-webcomponents/test/queries
          - test_suite: xsjs-models
            test_path: javascript/frameworks/xsjs/test/models
          - test_suite: xsjs-queries
            test_path: javascript/frameworks/xsjs/test/queries
          - test_suite: heuristic-models
            test_path: javascript/heuristic-models/tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup CodeQL CLI
        id: setup-codeql
        shell: bash
        run: |
          # Read CodeQL CLI version from qlt.conf.json
          CLI_VERSION=$(sed -n 's/.*"CodeQLCLI"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' qlt.conf.json)

          # Ensure version has 'v' prefix for GitHub releases
          if [[ ! "$CLI_VERSION" =~ ^v ]]; then
            VERSION="v$CLI_VERSION"
          else
            VERSION="$CLI_VERSION"
          fi

          echo "Installing CodeQL CLI version: $VERSION (from qlt.conf.json)"

          # Determine download URL for Windows
          DOWNLOAD_URL="https://github.com/github/codeql-cli-binaries/releases/download/$VERSION/codeql-win64.zip"

          # Create installation directory
          INSTALL_DIR="$RUNNER_TOOL_CACHE/codeql"
          mkdir -p "$INSTALL_DIR"

          # Download and extract CodeQL CLI
          ZIP_PATH="$RUNNER_TEMP/codeql.zip"
          echo "Downloading from: $DOWNLOAD_URL"
          if ! curl -fL -o "$ZIP_PATH" "$DOWNLOAD_URL"; then
            echo "Error: Failed to download CodeQL CLI"
            exit 1
          fi

          echo "Extracting CodeQL CLI to: $INSTALL_DIR"
          if ! unzip -q "$ZIP_PATH" -d "$INSTALL_DIR"; then
            echo "Error: Failed to extract CodeQL CLI"
            exit 1
          fi

          # Set up environment
          CODEQL_PATH="$INSTALL_DIR/codeql"
          CODEQL_EXE="$CODEQL_PATH/codeql.exe"

          if [ ! -f "$CODEQL_EXE" ]; then
            echo "Error: CodeQL executable not found at: $CODEQL_EXE"
            exit 1
          fi

          echo "CodeQL executable: $CODEQL_EXE"

          # Add to PATH for subsequent steps
          echo "$CODEQL_PATH" >> $GITHUB_PATH
          echo "CODEQL_HOME=$CODEQL_PATH" >> $GITHUB_ENV
          echo "codeql-path=$CODEQL_PATH" >> $GITHUB_OUTPUT

          # Verify installation
          "$CODEQL_EXE" --version

      - name: Verify CodeQL Installation
        shell: bash
        run: |
          echo "CodeQL version:"
          codeql --version

          echo ""
          echo "CodeQL resolve languages:"
          codeql resolve languages

      - name: Install QL Packs
        shell: bash
        run: |
          echo "Installing QL packs from qlpack.yml files..."

          # Find all qlpack.yml files and install dependencies
          while IFS= read -r qlpack; do
            dir=$(dirname "$qlpack")
            echo "Installing packs for: $dir"
            if ! pushd "$dir" > /dev/null; then
              echo "Error: Failed to change directory to $dir"
              continue
            fi
            if ! codeql pack install; then
              echo "Warning: Failed to install packs in $dir"
            fi
            popd > /dev/null
          done < <(find javascript -name "qlpack.yml")

          echo "QL pack installation complete"

      - name: Setup Node.js for CDS compilation
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'extractors/cds/tools/package-lock.json'

      - name: Verify Node.js and npm tools
        shell: bash
        run: |
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo "npx version: $(npx --version)"

          # Verify npx can access @sap/cds-dk
          echo "Testing npx access to @sap/cds-dk..."
          if ! npx --yes --package @sap/cds-dk@latest cds --version 2>/dev/null; then
            echo "CDS will be installed per-project as needed"
          fi

      - name: Compile CAP CDS files
        shell: bash
        run: |
          # Use the dedicated CDS compilation script that follows the same logic
          # as the CDS extractor's resolveCdsVersions function
          ./extractors/cds/tools/workflow/cds-compilation-for-actions.sh

      - name: Run CodeQL unit tests
        id: run-tests
        shell: bash
        env:
          LGTM_INDEX_XML_MODE: all
          LGTM_INDEX_FILETYPES: ".json:JSON\n.cds:JSON"
        run: |
          echo "Running CodeQL unit tests for: ${{ matrix.test_suite }}"

          # Create results directory
          RESULTS_DIR="$RUNNER_TEMP/test-results"
          mkdir -p "$RESULTS_DIR"

          # Get the test path for this matrix job
          TEST_PATH="${{ matrix.test_path }}"

          # Check if test path exists
          if [ ! -d "$TEST_PATH" ]; then
            echo "⚠️ Test path does not exist: $TEST_PATH"
            echo "Skipping tests for this suite"
            exit 0
          fi

          # Use CodeQL's strict test discovery to find valid tests
          echo "Resolving tests with strict test discovery in: $TEST_PATH"

          RESOLVE_OUTPUT_FILE="$RESULTS_DIR/resolve-output.txt"
          RESOLVE_ERROR_FILE="$RESULTS_DIR/resolve-errors.txt"

          # Run codeql resolve tests with strict discovery
          if ! codeql resolve tests --strict-test-discovery --format=text -- "$TEST_PATH" > "$RESOLVE_OUTPUT_FILE" 2> "$RESOLVE_ERROR_FILE"; then
            echo "❌ Failed to resolve tests"
            if [ -f "$RESOLVE_ERROR_FILE" ]; then
              cat "$RESOLVE_ERROR_FILE"
            fi
            exit 1
          fi

          # Read discovered test directories
          TEST_DIRS=()
          if [ -f "$RESOLVE_OUTPUT_FILE" ]; then
            while IFS= read -r line; do
              if [ -n "$line" ]; then
                TEST_DIRS+=("$line")
              fi
            done < "$RESOLVE_OUTPUT_FILE"
          fi

          if [ ${#TEST_DIRS[@]} -eq 0 ]; then
            echo "⚠️ No valid test directories found in: $TEST_PATH"
            echo "Skipping tests for this suite"
            exit 0
          fi

          echo "Found ${#TEST_DIRS[@]} valid test directory(ies):"
          printf "  - %s\n" "${TEST_DIRS[@]}"
          echo ""

          # Run tests using codeql test run
          echo "Running: codeql test run --format=text -- ${TEST_DIRS[*]}"

          OUTPUT_FILE="$RESULTS_DIR/test-output.txt"
          ERROR_FILE="$RESULTS_DIR/test-errors.txt"

          # Run tests and capture output
          set +e
          codeql test run --format=text -- "${TEST_DIRS[@]}" > "$OUTPUT_FILE" 2> "$ERROR_FILE"
          TEST_EXIT_CODE=$?
          set -e

          # Display output
          if [ -f "$OUTPUT_FILE" ]; then
            cat "$OUTPUT_FILE"
          fi

          if [ -f "$ERROR_FILE" ] && [ -s "$ERROR_FILE" ]; then
            echo "Standard Error Output:"
            cat "$ERROR_FILE"
          fi

          # Check exit code
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "❌ Tests failed with exit code: $TEST_EXIT_CODE"
            exit $TEST_EXIT_CODE
          fi

          echo "✅ Tests completed successfully"

      - name: Upload test results
        if: ${{ always() }}
        uses: actions/upload-artifact@v6
        with:
          name: windows-test-results-${{ matrix.test_suite }}
          path: |
            ${{ runner.temp }}/test-results/
          if-no-files-found: warn

  validate-results:
    name: Validate Windows Test Results
    needs: [run-windows-tests]
    if: ${{ !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download test results
        uses: actions/download-artifact@v7
        with:
          pattern: windows-test-results-*
          path: test-results/
          merge-multiple: true

      - name: Display test results
        shell: bash
        run: |
          echo "=== Windows Unit Test Results ==="

          # Check if results exist
          if [ ! -d "test-results/" ] || [ -z "$(find test-results/ -type f 2>/dev/null)" ]; then
            echo "❌ No test results found"
            exit 1
          fi

          # Display test output
          if [ -f "test-results/test-output.txt" ]; then
            echo "Test output:"
            cat test-results/test-output.txt
            echo ""
          fi

          # Check for failures
          if [ -f "test-results/test-output.txt" ]; then
            if grep -q "FAILED" test-results/test-output.txt 2>/dev/null; then
              echo "❌ Some tests failed"
              exit 1
            else
              echo "✅ All tests passed"
            fi
          fi

          echo "================================="
